<!-- vim: syntax=Markdown -->

# Giva Decode

## setup

```elixir
Mix.install([
  {:kino, "~> 0.4.1"}
])
```

## Giva module

ì‹¤ì œ ì„œë²„ì—ì„œ ì‚¬ìš©ëœ ì½”ë“œëŠ” [ì—¬ê¸°ì„œ](https://github.com/corp-momenti/momenti-elixir/blob/master/apps/momenti/lib/momenti/media/giva.ex) í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```elixir
defmodule Giva do
  @marker <<170, 187, 204, 221, 221, 204, 187, 170>>
  @giva_file "./data/bf506159-3d7b-4242-a254-a24b7b313e3c@0968E872-DBCE-43E0-BF92-B127C4D6A7EC_3_50.giva"

  defmodule Frame do
    defstruct [:id, :index, :image_bin]
  end

  def decode(<<bin::binary>>) do
    bin
    |> Stream.unfold(fn
      <<@marker::binary, frame_id::binary-size(36), frame_index::size(16), length::size(32),
        image_bin::binary-size(length), next::binary>> ->
        {%Frame{id: frame_id, index: frame_index, image_bin: image_bin}, next}

      <<>> ->
        nil
    end)
    |> Enum.to_list()
  end

  def read() do
    @giva_file |> File.read!()
  end

  def show(%Frame{image_bin: image_bin}) do
    Kino.Image.new(image_bin, "image/jpeg")
  end

  def marker, do: @marker
end
```

`Giva.read/0` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´, `bf506159-3d7b-4242-a254-a24b7b313e3c@0968E872-DBCE-43E0-BF92-B127C4D6A7EC_3_50.giva` íŒŒì¼ì„ ì½ì–´ì„œ ë°”ì´ë„ˆë¦¬ë¡œ ë¦¬í„´í•´ì¤ë‹ˆë‹¤.

```elixir
Giva.read()
```

`Giva.read/0` ì˜ ê²°ê³¼ë¥¼ `Giva.decode/1` ë¡œ íŒŒì´í”„í•´ì„œ `bf506159-3d7b-4242-a254-a24b7b313e3c@0968E872-DBCE-43E0-BF92-B127C4D6A7EC_3_50.giva` íŒŒì¼ì„ ë””ì½”ë“œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```elixir
frames = Giva.read() |> Giva.decode()
```

```elixir
Enum.at(frames, 0).image_bin |> byte_size() |> div(1024)
```

`Giva.show/1` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´, í”„ë ˆì„ì˜ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ğŸ˜

```elixir
Enum.at(frames, 0) |> Giva.show()
```

```elixir
max = length(frames)

Kino.animate(300, 0, fn i ->
  md = Enum.at(frames, rem(i, max)) |> Giva.show()
  {:cont, md, i + 1}
end)
```

<!-- livebook:{"persist_outputs":true} -->

# ffmpex

## setup

```elixir
Mix.install([
  {:ffmpex, "~> 0.10.0"},
  {:kino, "~> 0.5.2"}
])
```

<!-- livebook:{"output":true} -->

```
:ok
```

### Target

```
ffmpeg -y -ss 10 -i "https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4" -frames:v 20 aespa_%4d.png
```

2560â€ŠÃ—â€Š1440 í•´ìƒë„, 568 Mb, 3:40 ê¸¸ì´ì˜ ì˜ìƒì— ëŒ€í•´ì„œ

* cloudstorage ì— ì €ì¥ëœ ë¹„ë””ì˜¤ íŒŒì¼ì˜ í”„ë ˆì„ì„ decode í•´ì„œ íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°
* cloudstorage ì— ì €ì¥ëœ ë¹„ë””ì˜¤ íŒŒì¼ì˜ í”„ë ˆì„ì„ stdout ìœ¼ë¡œ ì¶œë ¥í•˜ê¸° (â¡ï¸ `kino`)

```elixir
FFprobe.streams("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
```

<!-- livebook:{"output":true} -->

```
{:ok,
 [
   %{
     "pix_fmt" => "yuv420p",
     "bit_rate" => "20552330",
     "disposition" => %{
       "attached_pic" => 0,
       "clean_effects" => 0,
       "comment" => 0,
       "default" => 1,
       "dub" => 0,
       "forced" => 0,
       "hearing_impaired" => 0,
       "karaoke" => 0,
       "lyrics" => 0,
       "original" => 0,
       "timed_thumbnails" => 0,
       "visual_impaired" => 0
     },
     "codec_name" => "h264",
     "bits_per_raw_sample" => "8",
     "nal_length_size" => "4",
     "time_base" => "1/19001",
     "has_b_frames" => 2,
     "coded_height" => 1440,
     "is_avc" => "true",
     "level" => 51,
     "display_aspect_ratio" => "16:9",
     "duration" => "219.836272",
     "duration_ts" => 4177109,
     "sample_aspect_ratio" => "1:1",
     "refs" => 1,
     "start_time" => "0.000000",
     "color_primaries" => "bt709",
     "coded_width" => 2560,
     "tags" => %{
       "handler_name" => "VideoHandler",
       "language" => "eng",
       "vendor_id" => "[0][0][0][0]"
     },
     "r_frame_rate" => "19001/317",
     "codec_tag_string" => "avc1",
     "color_range" => "tv",
     "index" => 0,
     "start_pts" => 0,
     "codec_tag" => "0x31637661",
     "nb_frames" => "13177",
     "color_transfer" => "bt709",
     "avg_frame_rate" => "19001/317",
     "color_space" => "bt709",
     "height" => 1440,
     "codec_type" => "video",
     "width" => 2560,
     "chroma_location" => "left",
     "codec_long_name" => "H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10",
     "closed_captions" => 0,
     "profile" => "High"
   },
   %{
     "avg_frame_rate" => "0/0",
     "bit_rate" => "129329",
     "bits_per_sample" => 0,
     "channel_layout" => "stereo",
     "channels" => 2,
     "codec_long_name" => "AAC (Advanced Audio Coding)",
     "codec_name" => "aac",
     "codec_tag" => "0x6134706d",
     "codec_tag_string" => "mp4a",
     "codec_type" => "audio",
     "disposition" => %{
       "attached_pic" => 0,
       "clean_effects" => 0,
       "comment" => 0,
       "default" => 1,
       "dub" => 0,
       "forced" => 0,
       "hearing_impaired" => 0,
       "karaoke" => 0,
       "lyrics" => 0,
       "original" => 0,
       "timed_thumbnails" => 0,
       "visual_impaired" => 0
     },
     "duration" => "219.889000",
     "duration_ts" => 10554672,
     "index" => 1,
     "nb_frames" => "10308",
     "profile" => "LC",
     "r_frame_rate" => "0/0",
     "sample_fmt" => "fltp",
     "sample_rate" => "48000",
     "start_pts" => 0,
     "start_time" => "0.000000",
     "tags" => %{
       "handler_name" => "SoundHandler",
       "language" => "eng",
       "vendor_id" => "[0][0][0][0]"
     },
     "time_base" => "1/48000"
   }
 ]}
```

## To File

```elixir
import FFmpex
use FFmpex.Options

FFmpex.new_command()
|> add_global_option(option_y())
|> add_input_file("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
|> add_file_option(option_ss(70))
|> add_output_file("./data/aespa.png")
|> add_stream_specifier(stream_type: :video)
|> add_stream_option(option_frames(1))
|> execute()
```

<!-- livebook:{"output":true} -->

```
{:ok, ""}
```

ì‹¤í–‰ì€ ëŒ€ë¶€ë¶„ 2ì´ˆ ê°„í˜¹ 5ì´ˆ ì •ë„ ê±¸ë¦°ë‹¤.
ë‹¤í–‰ì¸ ì ì€ ê°€ì ¸ì˜¤ëŠ” í”„ë ˆì„ì˜ ê°¯ìˆ˜ë¥¼ ëŠ˜ë¦¬ë”ë¼ë„ (10 ~ 20ê°œ) ê±¸ë¦¬ëŠ” ì‹œê°„ì—ëŠ” í° ì°¨ì´ê°€ ì—†ë‹¤ëŠ” ì ì´ë‹¤.

```elixir
content = File.read!("./data/aespa.png")
Kino.Image.new(content, "image/png")
```

## To stdout

```elixir
command =
  FFmpex.new_command()
  |> add_input_file("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
  |> add_file_option(option_ss(65))
  |> to_stdout()
  |> add_stream_specifier(stream_type: :video)
  |> add_stream_option(option_frames(1))
  |> add_stream_option(option_c("png"))
  |> add_file_option(option_f("image2pipe"))
```

<!-- livebook:{"output":true} -->

```
%FFmpex.Command{
  files: [
    %FFmpex.File{
      options: [
        %FFmpex.Option{
          argument: "image2pipe",
          contexts: [:input, :output],
          name: "-f",
          require_arg: true
        }
      ],
      path: "-",
      stream_specifiers: [
        %FFmpex.StreamSpecifier{
          metadata_key: nil,
          metadata_value: nil,
          options: [
            %FFmpex.Option{
              argument: "png",
              contexts: [:input, :output, :per_stream],
              name: "-c",
              require_arg: true
            },
            %FFmpex.Option{
              argument: 1,
              contexts: [:output, :per_stream],
              name: "-frames",
              require_arg: true
            }
          ],
          program_id: nil,
          stream_id: nil,
          stream_index: nil,
          stream_type: :video,
          usable: false
        }
      ],
      type: :output
    },
    %FFmpex.File{
      options: [
        %FFmpex.Option{argument: 65, contexts: [:input, :output], name: "-ss", require_arg: true}
      ],
      path: "https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4",
      stream_specifiers: [],
      type: :input
    }
  ],
  global_options: []
}
```

```elixir
command |> prepare() |> then(fn {cmd, args} -> cmd <> "" <> Enum.join(args, " ") end)
```

<!-- livebook:{"output":true} -->

```
"/usr/local/bin/ffmpeg-ss 65 -i https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4 -f image2pipe -c:v png -frames:v 1 -"
```

```elixir
command
|> execute()
|> then(fn
  {:ok, image} ->
    Kino.Image.new(image, "image/png")

  {:error, err} ->
    err
end)
```

To File ë³´ë‹¤ 2ë°° ì´ìƒ ê±¸ë¦°ë‹¤. (ì•½ 4~5ì´ˆ) ì–´ì§¸ì„œ ê·¸ëŸ° ê²ƒì¼ê¹Œ?

* To File ì˜ ê²½ìš° ffmpeg ì´ ê³§ì¥ file ë¡œ ì“´ë‹¤.
* To stdout ì˜ ê²½ìš° ffmpeg â¡ï¸ ffmpeg ì˜ stdout ì¶œë ¥ â¡ï¸ ffmpex ìœ¼ë¡œ ì „ë‹¬ (elixir) â¡ï¸ kino ë¡œ ì „ì†¡
  * ffmpeg ì˜ stdout ì¶œë ¥ â¡ï¸ ffmpex ìœ¼ë¡œ ì „ë‹¬ ì—ì„œ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ê¹Œ?
  * ê·¸ëŸ°ë° 2ë°°ë‚˜ ê±¸ë¦´ì •ë„ë¡œ ì˜¤ë˜ ê±¸ë¦´ ì¼ì¸ì§€ëŠ” ê¶ê¸ˆ

ê°€ì ¸ì˜¤ëŠ” í”„ë ˆì„ì„ 10ê°œë¡œ ëŠ˜ë¦¬ë©´ ì†ë„ëŠ” ë§¤ìš° ëŠë ¤ì§„ë‹¤. (20ì´ˆ ì´ìƒì´ ê±¸ë¦°ë‹¤ ğŸ¤”)

<!-- livebook:{"break_markdown":true} -->

### ì¤‘ê°„ ê²°ë¡ 

* To File, To stdout ëª¨ë‘ 1ì´ˆ ì´ë‚´ë¡œ í”„ë ˆì„ì„ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ì‰½ì§€ ì•Šì•„ ë³´ì¸ë‹¤.

## with jpeg

png ë¡œ í–ˆì„ë•Œ êº¼ë‚´ì˜¨ íŒŒì¼ì˜ ì‚¬ì´ì¦ˆê°€ ë¬´ë ¤ 4Mb ì— ë‹¬í•œë‹¤ëŠ” ê²ƒì„ ì•Œê²Œë¨. `jpeg` ë¡œ ë³€ê²½í•´ì„œ ê°€ì ¸ì˜¨ë‹¤ë©´?

```elixir
FFmpex.new_command()
|> add_global_option(option_y())
|> add_input_file("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
|> add_file_option(option_ss(70))
|> add_output_file("./data/aespa.jpeg")
|> add_stream_specifier(stream_type: :video)
|> add_stream_option(option_frames(1))
|> execute()

content = File.read!("./data/aespa.jpeg")
Kino.Image.new(content, "image/jpeg")
```

íŒŒì¼ì˜ ì‚¬ì´ì¦ˆëŠ” `4.2Mb` â¡ï¸ `163Kb` ë¡œ ë¬´ë ¤ 1/25 ë¡œ ì¤„ì–´ë“¤ì—ˆë‹¤. ì†ë„ë„ ë§¤ìš° ë¹ ë¥´ë‹¤.

```elixir
FFmpex.new_command()
|> add_input_file("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
|> add_file_option(option_ss(65))
|> to_stdout()
|> add_stream_specifier(stream_type: :video)
|> add_stream_option(option_frames(1))
|> add_stream_option(option_c("mjpeg"))
|> add_file_option(option_f("image2pipe"))
|> execute()
|> then(fn
  {:ok, image} ->
    Kino.Image.new(image, "image/png")

  {:error, err} ->
    err
end)
```

2ì´ˆ ë‚´ì™¸ë¡œ íŒŒì¼ì„ ë§Œë“¤ì§€ ì•Šê³  `Kino` ë¡œ ë‚´ë ¤ì¤„ ìˆ˜ ìˆë‹¤!! ê·¸ë ‡ë‹¤ë©´ stdout ìœ¼ë¡œ ì—¬ëŸ¬ í”„ë ˆì„ì„ ê°€ì ¸ì˜¨ ê²½ìš°, ì–´ë–»ê²Œ í´ë¼ì´ì–¸íŠ¸ì— ë‚´ë ¤ì¤„ ìˆ˜ ìˆì„ê¹Œ?

JPEG ì´ë¯¸ì§€ëŠ” SOI ë¡œ ì‹œì‘í•˜ê³ (`FF D8`), EOI(`FF D9`) ë¡œ ëë‚œë‹¤. ë°”ì´ë„ˆë¦¬ì—ì„œ ì´ ë¶€ë¶„ì„ ì°¾ì•„ì„œ ì´ë¯¸ì§€ë¥¼ ì˜ë¼ë‚´ë ¤ì£¼ë©´ ëœë‹¤.

https://en.wikipedia.org/wiki/JPEG#Syntax_and_structure

```elixir
# start of image
soi = <<255, 216>>

jpeg_images =
  FFmpex.new_command()
  |> add_input_file("https://storage.googleapis.com/momenti-staging-public-2/content/aespa.mp4")
  |> add_file_option(option_ss(200))
  |> to_stdout()
  |> add_stream_specifier(stream_type: :video)
  |> add_stream_option(option_frames(30))
  |> add_stream_option(option_c("mjpeg"))
  |> add_file_option(option_f("image2pipe"))
  |> execute()
  |> then(fn
    {:ok, image} ->
      image

    {:error, err} ->
      err
  end)
  |> :binary.split(soi, [:global, :trim_all])
  |> Enum.map(&(soi <> &1))
```

<!-- livebook:{"output":true} -->

```
[
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, 8, 16, 16, 19, 16,
    ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, 8, 12, 12, 14,
    ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, 8, 10, 10, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, 8, 14, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, 8, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, 0, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, 67, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, 0, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, 219, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, 255, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, 0, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, 48, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, 48, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, 49, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, 46, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, 52, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, 51, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, 49, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, 46, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, 56, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, 53, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, 99, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, 118, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    97, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, 76,
    ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, 17, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, 0, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, 254, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, 255, ...>>,
  <<255, 216, 255, 224, 0, 16, 74, 70, 73, 70, 0, 1, 2, 0, 0, 1, 0, 1, 0, 0, ...>>
]
```

200 ì´ˆ ì´í›„ì˜ í”„ë ˆì„ 30ê°œë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒë„ 3ì´ˆ ë‚´ì™¸ë¡œ ëë‚œë‹¤.

```elixir
max = length(jpeg_images)

Kino.animate(100, 0, fn i ->
  img = Enum.at(jpeg_images, rem(i, max)) |> Kino.Image.new("image/jpeg")
  {:cont, img, i + 1}
end)
```
